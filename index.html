<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power of Periwinkle - Global Illumination Map</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #dcdcfc;
            overflow: hidden;
            min-height: 100vh;
        }

        #map-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        svg#map {
            width: 100%;
            height: 100%;
            display: block;
            position: absolute;
            z-index: 1;
        }

        .land {
            fill: #3a3a5a;
            stroke: #6a6a9a;
            stroke-width: 0.6;
            transition: fill 0.5s ease;
            filter: drop-shadow(0 0 4px rgba(204,204,255,0.15));
        }
        .land:hover {
            fill: #4a4a70;
            filter: drop-shadow(0 0 10px rgba(204,204,255,0.4));
        }

        .graticule {
            fill: none;
            stroke: #1c1c29;
            stroke-width: 0.5;
            opacity: 0.3;
        }

        .header-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(to bottom, rgba(10,10,15,0.95) 0%, rgba(10,10,15,0) 100%);
            padding: 15px 30px;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-image {
            height: 80px;
            width: auto;
            pointer-events: auto;
            filter: drop-shadow(0 0 15px rgba(204,204,255,0.9))
                    drop-shadow(0 0 25px rgba(204,204,255,0.6))
                    brightness(1.2);
            animation: logo-breathe 6s ease-in-out infinite;
        }

        @keyframes logo-breathe {
            0%, 100% {
                filter: drop-shadow(0 0 12px rgba(204,204,255,0.8))
                        drop-shadow(0 0 20px rgba(204,204,255,0.5))
                        brightness(1.1);
            }
            50% {
                filter: drop-shadow(0 0 25px rgba(204,204,255,1))
                        drop-shadow(0 0 40px rgba(204,204,255,0.8))
                        brightness(1.3);
            }
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }

        .header-text h1 {
            font-size: 1.6rem;
            font-weight: 300;
            letter-spacing: 0.3em;
            color: #e0e0ff;
            text-transform: uppercase;
            margin-bottom: 5px;
            background: linear-gradient(110deg, #a0a0c0 30%, #ffffff 45%, #ccccff 55%, #a0a0c0 70%);
            background-size: 400% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: sweep-shine 12s linear infinite;
        }

        @keyframes sweep-shine {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }

        .tm-script {
            font-size: 0.3em;
            vertical-align: top;
            position: relative;
            top: -0.2em;
            margin-left: -8px;
            color: #ccccff;
            -webkit-text-fill-color: #ccccff;
            font-style: normal;
            letter-spacing: 0;
        }

        .header-text p {
            font-size: 0.85rem;
            color: rgba(220,220,255,0.8);
            letter-spacing: 0.1em;
        }

        .mgf-glow {
            display: inline-block;
            font-weight: 600;
            color: #ccccff;
            animation: comet-breath 5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes comet-breath {
            0%, 20% { text-shadow: 0 0 0px rgba(204,204,255,0); color: #ccccff; }
            50% { text-shadow: 0 0 15px rgba(204,204,255,0.9), 0 0 30px rgba(204,204,255,0.6); color: #ffffff; }
            80%, 100% { text-shadow: 0 0 0px rgba(204,204,255,0); color: #ccccff; }
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 8px;
            pointer-events: auto;
        }

        .year-btn {
            background: rgba(40,40,60,0.8);
            border: 1px solid rgba(204,204,255,0.4);
            color: #dcdcfc;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .year-btn:hover {
            background: rgba(204,204,255,0.25);
            border-color: rgba(204,204,255,0.6);
        }

        .year-btn.active {
            background: rgba(204,204,255,0.3);
            border-color: #ccccff;
            color: #fff;
            box-shadow: 0 0 15px rgba(204,204,255,0.5);
        }

        .site-marker { cursor: pointer; }
        .marker-pulse {
            fill: #ccccff;
            filter: drop-shadow(0 0 8px rgba(204,204,255,0.9));
        }
        .marker-ring {
            fill: none;
            stroke: rgba(204,204,255,0.95);
            stroke-width: 2;
        }
        .marker-line {
            stroke: rgba(204,204,255,0.4);
            stroke-width: 0.5;
            stroke-dasharray: 2,2;
        }

        .marker-label {
            font-size: 8.5px;
            fill: #e8e8ff;
            pointer-events: none;
            text-shadow: 0 0 4px #0a0a0f, 0 0 8px #0a0a0f, 0 0 12px rgba(10,10,15,0.8);
            filter: drop-shadow(0 0 2px rgba(204,204,255,0.3));
        }

        .marker-label .city-name {
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 8.5px;
        }

        .marker-label .site-count {
            font-weight: 800;
            font-size: 9px;
            fill: #ffffff;
        }

        .cluster-marker {
            cursor: pointer;
        }

        .cluster-circle {
            fill: rgba(204,204,255,0.25);
            stroke: #ccccff;
            stroke-width: 2.5;
            filter: drop-shadow(0 0 10px rgba(204,204,255,0.7));
        }

        .cluster-count {
            font-size: 12px;
            font-weight: 700;
            fill: #ffffff;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }

        .star {
            fill: #ffffff;
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.8));
        }

        .star-big {
            fill: #ffffff;
            filter: drop-shadow(0 0 4px rgba(255,255,255,1)) drop-shadow(0 0 8px rgba(204,204,255,0.6));
        }

        .star-pointy {
            fill: #ccccff;
            filter: drop-shadow(0 0 2px rgba(204,204,255,0.9));
            animation: star-twinkle 2s ease-in-out infinite;
        }

        @keyframes star-twinkle {
            0%, 100% {
                opacity: 0.6;
                filter: drop-shadow(0 0 2px rgba(204,204,255,0.8));
            }
            50% {
                opacity: 1;
                filter: drop-shadow(0 0 4px rgba(204,204,255,1))
                        drop-shadow(0 0 8px rgba(204,204,255,0.6));
            }
        }

        .spotlight {
            fill: url(#beam-gradient);
            mix-blend-mode: screen;
            opacity: 0.25;
            transform-origin: 50% 100%;
            animation: scan-swing 18s ease-in-out infinite alternate;
        }

        .spotlight-2 { animation-duration: 24s; animation-delay: -6s; opacity: 0.2; }
        .spotlight-3 { animation-duration: 30s; animation-delay: -12s; opacity: 0.15; }

        @keyframes scan-swing {
            0% { transform: rotate(-20deg) scaleY(1); }
            50% { transform: rotate(0deg) scaleY(1.05); }
            100% { transform: rotate(20deg) scaleY(1); }
        }

        .tooltip {
            position: fixed;
            background: #e6e1d3;
            border: 2px solid #f4d03f;
            box-shadow: 0 0 25px rgba(244,208,63,0.6), 0 0 35px rgba(204,204,255,0.5), inset 0 0 30px rgba(244,208,63,0.15);
            border-radius: 8px;
            padding: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
            z-index: 2000;
            width: 280px;
            overflow: hidden;
            color: #2a2a35;
            transform: scale(0.95);
        }

        .tooltip.visible {
            opacity: 1;
            transform: scale(1);
            animation: card-float 3s ease-in-out infinite;
        }

        @keyframes card-float {
            0%, 100% { transform: scale(1) translateY(0px); }
            50% { transform: scale(1) translateY(-3px); }
        }

        .tooltip-photo-container {
            width: 280px;
            height: 280px;
            background: #d0c8b0;
            position: relative;
            border-bottom: 1px solid rgba(42,42,53,0.1);
            overflow: hidden;
        }

        .tooltip-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
        }

        .tooltip-content { padding: 15px 18px; }

        .tooltip-landmark {
            font-size: 1.15rem;
            font-weight: 800;
            color: #2a2a35;
            margin-bottom: 4px;
            line-height: 1.2;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tooltip-city {
            font-size: 0.9rem;
            color: #555;
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(42,42,53,0.1);
            padding-bottom: 10px;
        }

        .tooltip-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: 5px;
        }

        .tooltip-country {
            font-size: 0.95rem;
            font-weight: 700;
            color: #2a2a35;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: right;
        }

        .thank-you-box {
            background: #2a2a35;
            color: #f4d03f;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 1px solid #f4d03f;
            box-shadow: 0 0 8px #f4d03f;
            animation: thanks-pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes thanks-pulse {
            0% { transform: scale(1); box-shadow: 0 0 8px #f4d03f; }
            100% { transform: scale(1.05); box-shadow: 0 0 18px #f4d03f; }
        }

        .bottom-center-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 20px;
            align-items: flex-end;
        }

        .stats-overlay {
            background: rgba(25,25,40,0.85);
            border: 1px solid rgba(204,204,255,0.3);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 0 15px rgba(204,204,255,0.2);
        }

        .stats-overlay .stat-value {
            font-size: 1.5rem;
            font-weight: 300;
            color: #ccccff;
        }

        .stats-overlay .stat-label {
            color: rgba(204,204,255,0.6);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .countdown-timer {
            background: rgba(25,25,40,0.85);
            border: 1px solid rgba(204,204,255,0.3);
            border-radius: 8px;
            padding: 15px 20px;
            color: #ccccff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(204,204,255,0.2);
            animation: hum 4.3s ease-in-out infinite alternate;
            min-height: 68px;
        }

        @keyframes hum {
            0% { box-shadow: 0 0 10px rgba(204,204,255,0.2); }
            100% { box-shadow: 0 0 20px rgba(204,204,255,0.4); }
        }

        .countdown-time {
            font-family: 'Inter', monospace;
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 0.1em;
        }

        .countdown-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            opacity: 0.7;
            margin-top: 2px;
            letter-spacing: 0.15em;
        }

        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: rgba(40,40,60,0.8);
            border: 1px solid rgba(204,204,255,0.3);
            color: #ccccff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: rgba(204,204,255,0.15);
            box-shadow: 0 0 10px rgba(204,204,255,0.3);
        }

        .logo-container {
            position: fixed;
            bottom: 5%;
            left: calc(5% - 50px);
            width: 450px;
            height: 450px;
            pointer-events: none;
            z-index: 500;
            opacity: 0.4;
            overflow: visible;
        }

        .logo-container svg { width: 100%; height: 100%; overflow: visible; }

        .logo-text-path {
            fill: #ccccff;
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 0.25em;
            text-transform: uppercase;
        }

        .logo-center-group { animation: center-pulse 6s ease-in-out infinite; }

        @keyframes center-pulse {
            0%, 100% { filter: drop-shadow(0 0 3px rgba(204,204,255,0.4)); transform: scale(1); }
            50% { filter: drop-shadow(0 0 18px rgba(204,204,255,0.7)); transform: scale(1.02); }
        }

        .rings-group { animation: ring-glow-breathe 9s ease-in-out infinite; transform-origin: center; opacity: 0.9; }

        @keyframes ring-glow-breathe {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(204,204,255,0.7)); }
            50% { filter: drop-shadow(0 0 25px rgba(204,204,255,1)); }
        }

        .ring-1 { animation: rotate-slow 50s linear infinite; transform-origin: center; }
        .ring-2 { animation: rotate-rev 70s linear infinite; transform-origin: center; }

        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotate-rev { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }

        .clock-widget {
            position: fixed;
            bottom: 90px;
            right: 140px;
            width: 140px;
            height: auto;
            z-index: 800;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            pointer-events: none;
            transform: scale(2.5);
            transform-origin: bottom right;
            opacity: 0.5;
        }

        .clock-face { width: 100px; height: 100px; }
        .clock-border { stroke: #e0e0ff; stroke-width: 0.75; fill: rgba(10, 10, 20, 0.05); }
        .hand { stroke-linecap: round; transform-origin: 50px 50px; }
        .hour-hand { stroke: #e0e0ff; stroke-width: 1.5; }
        .min-hand { stroke: #e0e0ff; stroke-width: 1.0; }
        .sec-hand { stroke: #ffffff; stroke-width: 0.5; opacity: 0.9; }
        .clock-center { fill: #e0e0ff; }

        .clock-date {
            font-family: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-weight: 900;
            font-size: 0.4rem;
            letter-spacing: -0.05em;
            text-transform: uppercase;
            text-align: center;
            margin-top: 12px;
            z-index: 801;
        }

        .date-peri { color: #ccccff; }
        .date-white { color: #f0f0f0; }

        .autoplay-controls {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
        }

        .autoplay-btn {
            background: rgba(40,40,60,0.8);
            border: 1px solid rgba(204,204,255,0.4);
            color: #dcdcfc;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .autoplay-btn:hover {
            background: rgba(204,204,255,0.25);
            border-color: rgba(204,204,255,0.6);
        }

        .autoplay-btn.active {
            background: rgba(204,204,255,0.3);
            border-color: #ccccff;
            color: #fff;
            box-shadow: 0 0 15px rgba(204,204,255,0.5);
        }

        #rotate-message { display: none; }
        @media screen and (orientation: portrait) and (max-width: 900px) {
            #rotate-message {
                display: flex; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                background: #0a0a0f; z-index: 9999; align-items: center; justify-content: center;
                text-align: center; color: #ccccff;
            }
            .rotate-icon { font-size: 50px; margin-bottom: 20px; animation: spin 2s infinite linear; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(180deg); } }
            .controls, .zoom-controls, .bottom-center-container, .header-overlay { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="rotate-message">
        <div>
            <div class="rotate-icon">⟳</div>
            <h2>Please rotate your device.</h2>
            <p style="color:#888;">The map is designed for landscape viewing.</p>
        </div>
    </div>

    <div class="header-overlay">
        <img src="https://images.squarespace-cdn.com/content/v1/572ffa0e27d4bdb4d519789e/1554086301102-A3JWP77TLEODYKY22TRY/MGF_LOGO_SCFOC_BLU_small.png"
             alt="MyGutFeeling Logo"
             class="logo-image">
        <div class="header-text">
            <h1>THE POWER OF PERIWINKLE<sup class="tm-script">TM</sup></h1>
            <p><span class="mgf-glow">MyGutFeeling</span> Global Illumination Sites</p>
        </div>
    </div>

    <div class="controls">
        <!-- Hidden 2025 toggle - will be revealed when 2025 data exists -->
        <button class="year-btn year-2025-toggle" data-year="2025" style="display: none;">2025</button>
    </div>

    <div class="autoplay-controls">
        <button class="autoplay-btn" id="autoplay-toggle">▶ Auto-Play Tour</button>
    </div>

    <div id="map-container">
        <svg id="map">
            <defs>
                <linearGradient id="beam-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ccccff; stop-opacity:0.3" />
                    <stop offset="100%" style="stop-color:#ccccff; stop-opacity:0.4" />
                </linearGradient>
                <linearGradient id="comet-gradient" gradientUnits="objectBoundingBox">
                    <stop offset="0%" style="stop-color: #fff; stop-opacity: 1;" />
                    <stop offset="100%" style="stop-color: #ccccff; stop-opacity: 0;" />
                </linearGradient>
                <filter id="glow">
                    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
        </svg>

        <div class="logo-container">
            <svg viewBox="0 0 400 400">
                <defs>
                    <path id="circle1" d="M 200, 200 m -100, 0 a 100,100 0 1,1 200,0 a 100,100 0 1,1 -200,0" />
                    <path id="circle2" d="M 200, 200 m -120, 0 a 120,120 0 1,1 240,0 a 120,120 0 1,1 -240,0" />
                </defs>

                <g class="logo-center-group">
                    <image href="https://images.squarespace-cdn.com/content/572ffa0e27d4bdb4d519789e/3c24d684-bec3-4ab1-91e0-3c56e9e68943/TPOP_2026P_Peri.png" x="100" y="100" width="200" height="200" opacity="1"/>
                    <circle cx="200" cy="200" r="85" fill="none" stroke="rgba(204,204,255,0.2)" stroke-width="1" />
                </g>

                <g class="rings-group">
                    <g class="ring-1">
                        <text class="logo-text-path" style="font-weight: 700; font-size: 15px; letter-spacing: 0.1em;">
                            <textPath href="#circle1" startOffset="0%">
                                Stomach Cancer Awareness Education Advocacy Stomach Cancer Awareness Education Advocacy
                            </textPath>
                        </text>
                    </g>
                    <g class="ring-2">
                        <text class="logo-text-path" style="font-size: 14px; font-weight: 800; letter-spacing: 0.04em; opacity: 1;">
                            <textPath href="#circle2" startOffset="50%">
                                Stomach Cancer Foundation of Canada
                            </textPath>
                        </text>
                    </g>
                </g>
            </svg>
        </div>

        <div class="clock-widget">
            <svg viewBox="0 0 100 100" class="clock-face">
                <circle cx="50" cy="50" r="48" class="clock-border"/>
                <line x1="50" y1="50" x2="50" y2="25" class="hand hour-hand" id="hour-hand" />
                <line x1="50" y1="50" x2="50" y2="15" class="hand min-hand" id="min-hand" />
                <line x1="50" y1="50" x2="50" y2="10" class="hand sec-hand" id="sec-hand" />
                <circle cx="50" cy="50" r="2" class="clock-center"/>
            </svg>
            <div class="clock-date" id="clock-date"></div>
        </div>
    </div>

    <div class="bottom-center-container">
        <div class="stats-overlay">
            <div class="stat-value" id="site-count">0</div>
            <div class="stat-label">Illumination Sites</div>
        </div>

        <div class="countdown-timer" id="countdown-display" style="display: none;">
            <div class="countdown-time" id="countdown-val">00:00:00</div>
            <div class="countdown-label">To Nov 30</div>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-out">−</button>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>

    <script>
        let sites = [];

        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select("#map").attr("viewBox", [0, 0, width, height]);

        const projection = d3.geoNaturalEarth1().scale(width / 5.5).translate([width / 2, height / 2]);
        const path = d3.geoPath().projection(projection);
        let currentTransform = d3.zoomIdentity;

        const zoom = d3.zoom()
            .scaleExtent([1, 12])
            .on("zoom", (event) => {
                currentTransform = event.transform;
                g.attr("transform", event.transform);
            });
        svg.call(zoom);
        const g = svg.append("g");

        let cometInterval;

        function createStars() {
            const starsGroup = g.append("g").attr("class", "stars-layer");

            for (let i = 0; i < 200; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const r = Math.random() * 0.8 + 0.3;
                const duration = Math.random() * 4 + 2;
                const delay = Math.random() * 6;

                starsGroup.append("circle")
                    .attr("class", "star")
                    .attr("cx", x).attr("cy", y).attr("r", r)
                    .style("opacity", Math.random() * 0.4 + 0.1)
                    .style("animation", `twinkle ${duration}s ease-in-out ${delay}s infinite`);
            }

            for (let i = 0; i < 50; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const r = Math.random() * 1.5 + 1;
                const duration = Math.random() * 3 + 1.5;
                const delay = Math.random() * 5;

                starsGroup.append("circle")
                    .attr("class", "star-big")
                    .attr("cx", x).attr("cy", y).attr("r", r)
                    .style("opacity", Math.random() * 0.6 + 0.2)
                    .style("animation", `sparkle ${duration}s ease-in-out ${delay}s infinite`);
            }

            const starPath = "M 0,-10 L 2.5,-3 L 10,-3 L 4,2 L 6,10 L 0,5 L -6,10 L -4,2 L -10,-3 L -2.5,-3 Z";

            for (let i = 0; i < 10; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const scale = Math.random() * 0.3 + 0.3;
                const delay = Math.random() * 3;

                starsGroup.append("path")
                    .attr("class", "star-pointy")
                    .attr("d", starPath)
                    .attr("transform", `translate(${x},${y}) scale(${scale})`)
                    .style("animation-delay", `${delay}s`);
            }
        }

        function createSkyBeams() {
            const beamGroup = g.append("g").attr("class", "sky-beams-layer");
            beamGroup.append("path").attr("d", `M -50,${height+50} L ${width*0.4},${-200} L ${width*0.6},${-200} Z`).attr("class", "spotlight spotlight-1");
            beamGroup.append("path").attr("d", `M ${width+50},${height+50} L ${width*0.3},${-200} L ${width*0.5},${-200} Z`).attr("class", "spotlight spotlight-2");
            beamGroup.append("path").attr("d", `M ${width/2},${height+100} L ${width*0.1},${-100} L ${width*0.3},${-100} Z`).attr("class", "spotlight spotlight-3");
        }

        function launchComet() {
            // Gentle diagonal path from upper corners
            const fromLeft = Math.random() < 0.5;
            const startX = fromLeft ? -30 : width + 30;
            const startY = Math.random() * height * 0.3 + 20;
            const endX = fromLeft ? width * 0.6 + Math.random() * width * 0.3 : width * 0.1 + Math.random() * width * 0.3;
            const endY = startY + height * 0.4 + Math.random() * height * 0.2;

            // Gentle arc - almost straight line
            const cpX = (startX + endX) / 2;
            const cpY = (startY + endY) / 2 - 30;

            const cometPath = g.append("path")
                .attr("d", `M ${startX},${startY} Q ${cpX},${cpY} ${endX},${endY}`)
                .style("fill", "none").style("stroke", "none");

            const cometGroup = g.append("g");

            // Slim jet-line tail
            cometGroup.append("line")
                .attr("x1", 0).attr("y1", 0)
                .attr("x2", -40).attr("y2", 0)
                .style("stroke", "url(#comet-gradient)")
                .style("stroke-width", 1.5)
                .style("stroke-linecap", "round");

            // Small bright head
            cometGroup.append("circle").attr("r", 1.5)
                .style("fill", "#fff").style("filter", "url(#glow)");

            // Slow, graceful movement (15-25 seconds)
            const duration = 15000 + Math.random() * 10000;

            cometGroup.transition().duration(duration).ease(d3.easeLinear)
                .attrTween("transform", function() {
                    const l = cometPath.node().getTotalLength();
                    return function(t) {
                        const p = cometPath.node().getPointAtLength(t * l);
                        const pNext = cometPath.node().getPointAtLength(Math.min(t * l + 1, l));
                        const angle = Math.atan2(pNext.y - p.y, pNext.x - p.x) * 180 / Math.PI;
                        return `translate(${p.x},${p.y}) rotate(${angle})`;
                    };
                })
                .on("end", () => {
                    cometGroup.remove();
                    cometPath.remove();
                });
        }

        function startCometGeneration() {
            // First comet after 5 seconds
            setTimeout(launchComet, 5000);
            // Very rare comets - one every 25-45 seconds
            cometInterval = setInterval(() => {
                launchComet();
            }, 25000 + Math.random() * 20000);
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes twinkle {
                0%, 100% { opacity: 0.1; }
                50% { opacity: 0.6; }
            }
            @keyframes sparkle {
                0%, 100% { opacity: 0.3; transform: scale(1); }
                50% { opacity: 1; transform: scale(1.3); }
            }
            @keyframes pulse-ring {
                0% { r: 4; opacity: 0.9; }
                100% { r: 22; opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Load data from JSON file
        fetch('data.json')
            .then(response => response.json())
            .then(data => {
                sites = data;
                initMap();
            })
            .catch(err => {
                console.error("Failed to load data.json", err);
                sites = [];
                initMap();
            });

        function initMap() {
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(world => {
                const graticule = d3.geoGraticule();
                g.append("path").datum(graticule).attr("class", "graticule").attr("d", path);
                g.append("path").datum(topojson.feature(world, world.objects.land)).attr("class", "land").attr("d", path);

                createStars();
                createSkyBeams();
                startCometGeneration();

                // Check if 2025 data exists and show toggle if so
                const has2025 = sites.some(s => s.year === 2025);
                if (has2025) {
                    document.querySelector('.year-2025-toggle').style.display = 'block';
                }

                // Show all data by default
                renderMarkers('all');
            }).catch(err => {
                console.error("Failed to load map data", err);
            });
        }

        const tooltip = document.getElementById('tooltip');
        let autoplayInterval;
        let isAutoPlaying = false;

        function clusterSitesByCity(sitesData) {
            const clusters = {};
            sitesData.forEach(site => {
                const key = `${site.city}-${site.country}`;
                if (!clusters[key]) {
                    clusters[key] = {
                        city: site.city,
                        country: site.country,
                        province: site.province,
                        lat: site.lat,
                        lng: site.lng,
                        sites: [],
                        year: site.year
                    };
                }
                clusters[key].sites.push(site);
            });
            return Object.values(clusters);
        }

        function renderMarkers(year) {
            g.selectAll(".site-group").remove();
            g.selectAll(".cluster-group").remove();
            g.selectAll(".expanded-site").remove();

            const filteredSites = year === 'all' ? sites : sites.filter(s => s.year === parseInt(year));
            const clusters = clusterSitesByCity(filteredSites);

            clusters.forEach(cluster => {
                const [x, y] = projection([cluster.lng, cluster.lat]);
                cluster.x = x;
                cluster.y = y;
            });

            const clusterGroups = g.selectAll(".cluster-group")
                .data(clusters)
                .enter()
                .append("g")
                .attr("class", "cluster-group cluster-marker")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            clusterGroups.append("circle")
                .attr("class", "marker-ring")
                .attr("r", d => Math.min(10 + d.sites.length, 22))
                .style("animation", "pulse-ring 1.5s ease-out infinite")
                .style("animation-delay", d => Math.random() * 1 + "s");

            clusterGroups.append("circle")
                .attr("class", "cluster-circle")
                .attr("r", d => d.sites.length > 1 ? Math.min(7 + d.sites.length * 0.5, 16) : 5);

            clusterGroups.append("text")
                .attr("class", "marker-label")
                .attr("x", 12)
                .attr("y", 0)
                .attr("dy", "0.35em")
                .html(d => `<tspan class="city-name">${d.city}</tspan>${d.sites.length > 1 ? `<tspan class="site-count"> (${d.sites.length})</tspan>` : ''}`);

            clusterGroups.on("click", function(event, cluster) {
                event.stopPropagation();
                if (cluster.sites.length === 1) {
                    showTooltip(event, cluster.sites[0], cluster.x, cluster.y);
                } else {
                    expandCluster(cluster, d3.select(this));
                }
            });

            clusterGroups.on("mouseenter", function(event, cluster) {
                if (cluster.sites.length === 1) {
                    showTooltip(event, cluster.sites[0], cluster.x, cluster.y);
                }
            }).on("mouseleave", function() {
                if (!d3.select(this).classed("expanded")) {
                    tooltip.classList.remove('visible');
                }
            });

            document.getElementById('site-count').textContent = filteredSites.length;
        }

        function expandCluster(cluster, groupSelection) {
            g.selectAll(".expanded-site").remove();
            g.selectAll(".cluster-group").classed("expanded", false);

            groupSelection.classed("expanded", true);

            const siteCount = cluster.sites.length;
            const radius = 45 + (siteCount * 2);

            cluster.sites.forEach((site, i) => {
                const angle = (i / siteCount) * Math.PI * 2 - Math.PI / 2;
                const siteX = cluster.x + Math.cos(angle) * radius;
                const siteY = cluster.y + Math.sin(angle) * radius;

                const siteGroup = g.append("g")
                    .attr("class", "expanded-site")
                    .style("opacity", 0);

                siteGroup.append("line")
                    .attr("class", "marker-line")
                    .attr("x1", cluster.x).attr("y1", cluster.y)
                    .attr("x2", siteX).attr("y2", siteY);

                siteGroup.append("circle")
                    .attr("class", "marker-pulse")
                    .attr("cx", siteX).attr("cy", siteY).attr("r", 3);

                siteGroup.append("text")
                    .attr("class", "marker-label")
                    .attr("x", siteX + 8).attr("y", siteY).attr("dy", "0.35em")
                    .text(site.landmark);

                siteGroup.transition()
                    .duration(400)
                    .style("opacity", 1);

                siteGroup.on("click", function(event) {
                    event.stopPropagation();
                    showTooltip(event, site, siteX, siteY);
                });
            });

            svg.on("click.collapse", function() {
                g.selectAll(".expanded-site")
                    .transition()
                    .duration(300)
                    .style("opacity", 0)
                    .remove();
                groupSelection.classed("expanded", false);
                tooltip.classList.remove('visible');
                svg.on("click.collapse", null);
            });
        }

        function showTooltip(event, site, x, y) {
            const tx = currentTransform.applyX(x);
            const ty = currentTransform.applyY(y);

            const imgSrc = site.image || `https://via.placeholder.com/280x280/3a3a5a/ccccff?text=${encodeURIComponent(site.city)}`;

            tooltip.innerHTML = `
                <div class="tooltip-photo-container">
                    <img src="${imgSrc}" class="tooltip-img" alt="${site.landmark}" onerror="this.src='https://via.placeholder.com/280x280/3a3a5a/ccccff?text=No+Image'">
                </div>
                <div class="tooltip-content">
                    <div class="tooltip-landmark">${site.landmark}</div>
                    <div class="tooltip-city">${site.city}, ${site.province}</div>
                    <div class="tooltip-footer">
                        <div class="tooltip-country">${site.country}</div>
                        <div class="thank-you-box">THANK YOU!</div>
                    </div>
                </div>
            `;

            let left = tx + 20, top = ty - 160;
            if (left + 280 > window.innerWidth) left = tx - 300;
            if (top < 10) top = ty + 20;
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.add('visible');
        }

        document.querySelectorAll('.year-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                renderMarkers(this.dataset.year);
                stopAutoPlay();
            });
        });

        function startAutoPlay() {
            if (isAutoPlaying) return;
            isAutoPlaying = true;
            document.getElementById('autoplay-toggle').classList.add('active');
            document.getElementById('autoplay-toggle').innerHTML = '⏸ Pause Tour';

            const currentYear = document.querySelector('.year-btn.active').dataset.year;
            const filteredSites = currentYear === 'all' ? sites : sites.filter(s => s.year === parseInt(currentYear));

            filteredSites.sort((a, b) => a.lng - b.lng);

            let currentIndex = 0;

            function showNextSite() {
                if (!isAutoPlaying || currentIndex >= filteredSites.length) {
                    if (isAutoPlaying) {
                        currentIndex = 0;
                    } else {
                        return;
                    }
                }

                const site = filteredSites[currentIndex];
                const [x, y] = projection([site.lng, site.lat]);

                const scale = 3;
                const translate = [width / 2 - scale * x, height / 2 - scale * y];

                svg.transition()
                    .duration(800)
                    .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));

                setTimeout(() => {
                    if (isAutoPlaying) {
                        showTooltip({}, site, x, y);
                    }
                }, 900);

                currentIndex++;
            }

            showNextSite();
            autoplayInterval = setInterval(showNextSite, 2000);
        }

        function stopAutoPlay() {
            isAutoPlaying = false;
            clearInterval(autoplayInterval);
            document.getElementById('autoplay-toggle').classList.remove('active');
            document.getElementById('autoplay-toggle').innerHTML = '▶ Auto-Play Tour';
            tooltip.classList.remove('visible');

            svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity);
        }

        document.getElementById('autoplay-toggle').addEventListener('click', function() {
            if (isAutoPlaying) {
                stopAutoPlay();
            } else {
                startAutoPlay();
            }
        });

        document.getElementById('zoom-in').addEventListener('click', () => {
            stopAutoPlay();
            svg.transition().call(zoom.scaleBy, 1.5);
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            stopAutoPlay();
            svg.transition().call(zoom.scaleBy, 0.67);
        });

        function updateClock() {
            const now = new Date();
            const seconds = now.getSeconds();
            const minutes = now.getMinutes();
            const hours = now.getHours();
            const secDeg = (seconds / 60) * 360;
            const minDeg = (minutes / 60) * 360 + (seconds/60)*6;
            const hourDeg = (hours / 12) * 360 + (minutes/60)*30;

            document.getElementById('sec-hand').style.transform = `rotate(${secDeg}deg)`;
            document.getElementById('min-hand').style.transform = `rotate(${minDeg}deg)`;
            document.getElementById('hour-hand').style.transform = `rotate(${hourDeg}deg)`;

            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const dateHTML = `<span class="date-peri">${months[now.getMonth()]}</span> <span class="date-white">${now.getDate()}</span> <span class="date-peri">${now.getFullYear()}</span>`;
            document.getElementById('clock-date').innerHTML = dateHTML;
        }
        setInterval(updateClock, 1000);
        updateClock();

        function updateCountdown() {
            const now = new Date();
            const currentYear = now.getFullYear();
            let target = new Date(currentYear, 10, 30);
            if (now > target) {
                target = new Date(currentYear + 1, 10, 30);
            }
            const diff = target - now;
            const daysLeft = Math.floor(diff / (1000 * 60 * 60 * 24));
            const container = document.getElementById('countdown-display');
            if (daysLeft < 30) {
                container.style.display = 'flex';
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                const pad = (n) => n < 10 ? '0'+n : n;
                let timeString = `${pad(daysLeft)} : ${pad(hours)} : ${pad(minutes)} : ${pad(seconds)}`;
                document.getElementById('countdown-val').innerText = timeString;
            } else {
                container.style.display = 'none';
            }
        }
        setInterval(updateCountdown, 1000);
        updateCountdown();

        // Auto-start the tour after map loads
        setTimeout(() => {
            if (sites.length > 0) {
                startAutoPlay();
            }
        }, 2000);
    </script>
</body>
</html>
